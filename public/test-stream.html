<!DOCTYPE html>
<html>
<head>
    <title>HLS Stream Test</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body style="background: black; color: #00f0ff; font-family: monospace; padding: 20px;">
    <h1>HLS Stream Debugger</h1>
    <div>
        <label>HLS URL: </label>
        <input type="text" id="hlsUrl" value="http://localhost:8080/hls/livestream.m3u8" style="width: 500px; padding: 5px; background: #111; color: #00f0ff; border: 1px solid #00f0ff;">
        <button onclick="loadStream()" style="padding: 5px 15px; background: #00f0ff; color: black; border: none; cursor: pointer;">Load Stream</button>
    </div>
    <div style="margin-top: 20px;">
        <video id="video" controls autoplay muted style="width: 100%; max-width: 800px; background: #000;"></video>
    </div>
    <div id="status" style="margin-top: 20px; padding: 10px; background: #111; border: 1px solid #00f0ff;">
        <strong>Status:</strong> <span id="statusText">Ready</span>
    </div>
    <div id="logs" style="margin-top: 20px; padding: 10px; background: #111; border: 1px solid #00f0ff; max-height: 300px; overflow-y: auto;">
        <strong>Logs:</strong>
        <div id="logContent"></div>
    </div>

    <script>
        let hls = null;
        const video = document.getElementById('video');
        const statusText = document.getElementById('statusText');
        const logContent = document.getElementById('logContent');

        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${time}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function updateStatus(status) {
            statusText.textContent = status;
        }

        async function testUrl(url) {
            try {
                log(`Testing URL: ${url}`);
                const response = await fetch(url, { method: 'HEAD' });
                log(`Response status: ${response.status} ${response.statusText}`);
                return response.ok;
            } catch (error) {
                log(`Error testing URL: ${error.message}`);
                return false;
            }
        }

        function loadStream() {
            const url = document.getElementById('hlsUrl').value;
            logContent.innerHTML = '';
            log(`Starting stream load for: ${url}`);

            if (hls) {
                hls.destroy();
                hls = null;
            }

            testUrl(url).then(isAccessible => {
                if (!isAccessible) {
                    log('⚠️ Warning: URL may not be accessible (CORS or 404)');
                }
            });

            if (Hls.isSupported()) {
                log('HLS.js is supported');
                updateStatus('Initializing HLS player...');
                
                hls = new Hls({
                    debug: true,
                    enableWorker: true,
                    lowLatencyMode: true,
                });

                hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                    log('Media attached');
                    hls.loadSource(url);
                });

                hls.on(Hls.Events.MANIFEST_LOADING, () => {
                    log('Loading manifest...');
                    updateStatus('Loading manifest...');
                });

                hls.on(Hls.Events.MANIFEST_LOADED, (event, data) => {
                    log(`Manifest loaded: ${data.levels.length} quality levels`);
                    updateStatus(`Manifest loaded (${data.levels.length} qualities)`);
                });

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    log('Manifest parsed - ready to play');
                    updateStatus('Ready to play');
                    video.play().catch(e => {
                        log(`Autoplay blocked: ${e.message}`);
                    });
                });

                hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
                    log(`Switched to quality level ${data.level}`);
                });

                hls.on(Hls.Events.FRAG_LOADED, () => {
                    log('Fragment loaded');
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    log(`❌ ERROR: ${data.type} - ${data.details} (fatal: ${data.fatal})`);
                    updateStatus(`ERROR: ${data.details}`);
                    
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                log('Attempting to recover from network error...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                log('Attempting to recover from media error...');
                                hls.recoverMediaError();
                                break;
                            default:
                                log('Fatal error - cannot recover');
                                hls.destroy();
                                break;
                        }
                    }
                });

                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                log('Using Safari native HLS');
                updateStatus('Using Safari native HLS');
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    log('Metadata loaded');
                    updateStatus('Ready to play');
                });
                video.addEventListener('error', (e) => {
                    log(`Video error: ${e.type}`);
                    updateStatus(`Error: ${e.type}`);
                });
            } else {
                log('❌ HLS not supported');
                updateStatus('HLS not supported');
            }
        }

        // Auto-load on page load
        window.addEventListener('load', () => {
            log('Page loaded - ready to test');
        });
    </script>
</body>
</html>

